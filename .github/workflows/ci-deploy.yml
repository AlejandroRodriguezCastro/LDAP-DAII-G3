name: Test, Coverage, and Deploy to EC2 (openldap)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Ensure test deps
          pip install pytest pytest-cov coverage

      - name: Run tests with coverage
        run: |
          coverage run -m pytest -q
          coverage report -m
          coverage xml
          coverage html  # produces ./htmlcov/

      - name: Publish coverage summary
        run: |
          RATE=$(coverage report | tail -n1 | awk '{print $4}')
          echo "### Coverage: ${RATE}" >> $GITHUB_STEP_SUMMARY

      - name: Upload HTML coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: htmlcov
          path: htmlcov
          retention-days: 7

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main' && needs.test.result == 'success'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          install -m 600 /dev/null ~/.ssh/id_ec2
          printf "%s" "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ec2
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Rsync repository to EC2
        run: |
          TARGET="${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ vars.APP_DIR || '/opt/openldap' }}"
          rsync -az --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude '.venv/' \
            --exclude '__pycache__/' \
            --exclude 'htmlcov/' \
            --exclude '*.pyc' \
            -e "ssh -i ~/.ssh/id_ec2" ./ "$TARGET"/

      - name: Write .env on EC2 from multiline secret (secure 0600)
        run: |
          # Create temp on runner
          install -m 600 /dev/null .env.ci
          printf "%s" "${{ secrets.OPENLDAP_ENV_FILE }}" > .env.ci

          # Ship to EC2 and secure it
          scp -i ~/.ssh/id_ec2 ./.env.ci \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/openldap.env

          ssh -i ~/.ssh/id_ec2 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            'sudo install -m 600 -o root -g root /tmp/openldap.env /opt/openldap/.env && rm -f /tmp/openldap.env'

          rm -f .env.ci

      - name: Deploy (venv install + restart systemd)
        run: |
          ssh -i ~/.ssh/id_ec2 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash /opt/openldap/deploy.sh'

      # - name: Smoke test
      #   run: |
      #     # Try root or change to /health if you have one
      #     curl -fsS --retry 5 --retry-connrefused "http://${{ secrets.EC2_HOST }}:8081/" >/dev/null
